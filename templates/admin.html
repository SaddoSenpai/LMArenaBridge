<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Noni Proxy</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div>
                    <h1 class="title">Admin Panel</h1>
                    <p class="subtitle">Token Management & Analytics</p>
                </div>
                <div class="header-actions">
                    <span class="user-badge">{{ username }}</span>
                    <a href="/admin/logout" class="btn btn-secondary">Logout</a>
                </div>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-value">{{ stats.active_tokens }}</div>
                    <div class="stat-label">Active Tokens</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-value">{{ "{:,}".format(stats.total_requests) }}</div>
                    <div class="stat-label">Total Requests</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-content">
                    <div class="stat-value">{{ "{:,}".format(stats.total_tokens) }}</div>
                    <div class="stat-label">Total Tokens</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Create New Token</h2>
            </div>
            <form id="createTokenForm" class="token-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="userName">User Name (Optional)</label>
                        <input type="text" id="userName" name="user_name" class="form-input" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="userEmail">User Email (Optional)</label>
                        <input type="email" id="userEmail" name="user_email" class="form-input" placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary">Generate Token</button>
                    </div>
                </div>
            </form>
            <div id="newTokenDisplay" class="new-token-display hidden"></div>
        </div>

        <div class="section">
            <h2 class="section-title">Token Management</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Token ID</th>
                            <th>Created</th>
                            <th>Last Used</th>
                            <th>Status</th>
                            <th>Requests</th>
                            <th>Tokens</th>
                            <th>IPs</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tokensTableBody">
                        {% for token_id, token_data in tokens.items() %}
                        <tr data-token-id="{{ token_id }}">
                            <td><code class="token-id">{{ token_id }}</code></td>
                            <td>{{ token_data.created_at[:10] }}</td>
                            <td>{{ token_data.last_used[:19] if token_data.last_used else 'Never' }}</td>
                            <td>
                                {% if token_data.is_active %}
                                <span class="status-badge status-active">Active</span>
                                {% else %}
                                <span class="status-badge status-inactive">Inactive</span>
                                {% endif %}
                            </td>
                            <td>{{ "{:,}".format(token_data.usage_stats.total_requests) }}</td>
                            <td>{{ "{:,}".format(token_data.usage_stats.total_tokens) }}</td>
                            <td>{{ token_data.usage_stats.ip_addresses|length }}</td>
                            <td class="actions-cell">
                                <button onclick="viewToken('{{ token_id }}')" class="btn-text" title="View Details">View</button>
                                {% if token_data.is_active %}
                                <button onclick="revokeToken('{{ token_id }}')" class="btn-text btn-warning" title="Revoke">Revoke</button>
                                {% else %}
                                <button onclick="activateToken('{{ token_id }}')" class="btn-text btn-success" title="Activate">Activate</button>
                                {% endif %}
                                <button onclick="deleteToken('{{ token_id }}')" class="btn-text btn-danger" title="Delete">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Usage Analytics</h2>
            <div class="charts-grid">
                <div class="chart-box">
                    <h3 class="chart-title">Requests Over Time</h3>
                    <div class="chart-container-small">
                        <canvas id="requestsChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h3 class="chart-title">Geographic Distribution</h3>
                    <div class="chart-container-small">
                        <canvas id="geoChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="tokenModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Token Details</h2>
                    <button onclick="closeModal()" class="modal-close">&times;</button>
                </div>
                <div id="modalBody" class="modal-body"></div>
            </div>
        </div>
    </div>

    <script>
        // Create new token
        document.getElementById('createTokenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/admin/token/create', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const display = document.getElementById('newTokenDisplay');
                    display.innerHTML = `
                        <div class="success-message">
                            <h3>Token Created Successfully!</h3>
                            <p>Copy this token now - it won't be shown again:</p>
                            <div class="token-display">
                                <code>${data.token}</code>
                                <button onclick="copyToken('${data.token}')" class="btn btn-small">Copy</button>
                            </div>
                        </div>
                    `;
                    display.classList.remove('hidden');
                    e.target.reset();
                    setTimeout(() => location.reload(), 3000);
                }
            } catch (error) {
                alert('Error creating token: ' + error.message);
            }
        });

        function copyToken(token) {
            navigator.clipboard.writeText(token);
            alert('Token copied to clipboard!');
        }

        async function revokeToken(tokenId) {
            if (!confirm('Are you sure you want to revoke this token?')) return;
            
            try {
                const response = await fetch(`/admin/token/${tokenId}/revoke`, { method: 'POST' });
                const data = await response.json();
                if (data.success) location.reload();
            } catch (error) {
                alert('Error revoking token: ' + error.message);
            }
        }

        async function activateToken(tokenId) {
            try {
                const response = await fetch(`/admin/token/${tokenId}/activate`, { method: 'POST' });
                const data = await response.json();
                if (data.success) location.reload();
            } catch (error) {
                alert('Error activating token: ' + error.message);
            }
        }

        async function deleteToken(tokenId) {
            if (!confirm('Are you sure you want to permanently delete this token?')) return;
            
            try {
                const response = await fetch(`/admin/token/${tokenId}/delete`, { method: 'POST' });
                const data = await response.json();
                if (data.success) location.reload();
            } catch (error) {
                alert('Error deleting token: ' + error.message);
            }
        }

        async function viewToken(tokenId) {
            try {
                const response = await fetch(`/api/admin/tokens`);
                const tokens = await response.json();
                const token = tokens[tokenId];
                
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <div class="token-details-full">
                        <h3>Token ID: ${tokenId}</h3>
                        <div class="detail-section">
                            <h4>Basic Information</h4>
                            <div class="detail-row">
                                <span class="detail-label">Created:</span>
                                <span class="detail-value">${new Date(token.created_at).toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Last Used:</span>
                                <span class="detail-value">${token.last_used ? new Date(token.last_used).toLocaleString() : 'Never'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value">${token.is_active ? 'Active' : 'Inactive'}</span>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h4>Usage Statistics</h4>
                            <div class="detail-row">
                                <span class="detail-label">Total Requests:</span>
                                <span class="detail-value">${token.usage_stats.total_requests.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Total Tokens:</span>
                                <span class="detail-value">${token.usage_stats.total_tokens.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h4>IP Addresses (Last 10)</h4>
                            <ul class="ip-list">
                                ${token.usage_stats.ip_addresses.slice(-10).map(ip => `<li>${ip}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="detail-section">
                            <h4>Countries</h4>
                            <ul class="country-list">
                                ${Object.entries(token.usage_stats.countries).map(([country, count]) => 
                                    `<li>${country}: ${count} requests</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                
                document.getElementById('tokenModal').classList.remove('hidden');
            } catch (error) {
                alert('Error loading token details: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('tokenModal').classList.add('hidden');
        }

        // Load charts
        async function loadCharts() {
            try {
                const timelineResponse = await fetch('/api/usage/timeline?days=7');
                const timelineData = await timelineResponse.json();
                
                // Requests chart
                const ctx1 = document.getElementById('requestsChart').getContext('2d');
                new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: timelineData.map(d => d.date),
                        datasets: [{
                            label: 'Requests',
                            data: timelineData.map(d => d.requests),
                            backgroundColor: 'rgba(231, 76, 60, 0.8)',
                            borderColor: '#e74c3c',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#ecf0f1' } }
                        },
                        scales: {
                            x: { ticks: { color: '#95a5a6' }, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
                            y: { ticks: { color: '#95a5a6' }, grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                        }
                    }
                });

                // Geographic chart
                const tokensResponse = await fetch('/api/admin/tokens');
                const tokens = await tokensResponse.json();
                const countries = {};
                Object.values(tokens).forEach(token => {
                    Object.entries(token.usage_stats.countries).forEach(([country, count]) => {
                        countries[country] = (countries[country] || 0) + count;
                    });
                });

                const ctx2 = document.getElementById('geoChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(countries),
                        datasets: [{
                            data: Object.values(countries),
                            backgroundColor: [
                                '#e74c3c', '#9b59b6', '#3498db', '#2ecc71', '#f39c12',
                                '#e67e22', '#1abc9c', '#34495e', '#95a5a6', '#d35400'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#ecf0f1' } }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', loadCharts);
    </script>
</body>
</html>
